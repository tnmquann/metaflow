// conf/modules.config
process {
    withName: 'FASTQC_RAW' {
        publishDir = [
            [
                path: { "${params.qc_raw_dir}/${meta.id}" },
                mode: 'copy',
                pattern: "*_fastqc.{html,zip}"
            ],
            [
                path: { "${params.qc_raw_dir}" },
                mode: params.publish_dir_mode,
                pattern: "versions.yml"
            ]
        ]
    }

    // withName: 'MULTIQC_RAW' {
    //     publishDir = [
    //         [
    //             path: { "${params.qc_raw_dir}/MultiQC" },
    //             mode: 'copy',
    //             pattern: "*multiqc_report.html",
    //             saveAs: { "raw_shortreads_multiqc_report.html" }
    //         ]
    //     ]
    // }

    withName: 'FASTP' {
        publishDir = [
            [
                path: { "${params.trim_dir}/${meta.id}" },
                mode: 'copy',
                pattern: "*.fastq.gz"
            ],
            [
                path: { "${params.trim_dir}/${meta.id}/report" },
                mode: 'copy',
                pattern: "*.{json,html}"
            ],
            [
                path: { "${params.trim_dir}" },
                mode: params.publish_dir_mode,
                pattern: "versions.yml"
            ]
        ]
    }

    withName: 'FASTQC_TRIMMED' {
        publishDir = [
            [
                path: { "${params.qc_trim_dir}/${meta.id}" },
                mode: 'copy',
                pattern: "*_fastqc.{html,zip}"
            ],
            [
                path: { "${params.qc_trim_dir}" },
                mode: params.publish_dir_mode,
                pattern: "versions.yml"
            ]
        ]
    }

    // withName: 'MULTIQC_TRIMMED' {
    //     publishDir = [
    //         [
    //             path: { "${params.qc_trim_dir}/MultiQC" },
    //             mode: 'copy',
    //             pattern: "*multiqc_report.html",
    //             saveAs: { "trimmed_shortreads_multiqc_report.html" }
    //         ]
    //     ]
    // }

    withName: 'HOSTILE_CLEAN' {
        publishDir = [
            [
                path: { "${params.rmhost_dir}/${meta.id}" },
                mode: 'copy',
                pattern: "cleaned_reads/*.fastq.gz"
            ],
            [
                path: { "${params.rmhost_dir}/${meta.id}/report" },
                mode: 'copy',
                pattern: "*.json"
            ],
            [
                path: { "${params.rmhost_dir}" },
                mode: params.publish_dir_mode,
                pattern: "versions.yml"
            ]
        ]
    }

    withName: 'FASTQC_RMHOST' {
        publishDir = [
            [
                path: { "${params.qc_rmhost_dir}/${meta.id}" },
                mode: 'copy',
                pattern: "*_fastqc.{html,zip}"
            ],
            [
                path: { "${params.qc_rmhost_dir}" },
                mode: params.publish_dir_mode,
                pattern: "versions.yml"
            ]
        ]
    }

    withName: 'MEGAHIT' {
        ext.args   = { params.megahit_options ? params.megahit_options + " -m ${task.memory.toBytes()}" : "-m ${task.memory.toBytes()}" }
        ext.prefix = { "MEGAHIT-${meta.id}" }
        publishDir = [
            path: { "${params.outdir}/Assembly/MEGAHIT" },
            mode: params.publish_dir_mode,
            pattern: "*.{fa.gz,log}"
        ]
    }

    withName: 'METASPADES' {
        ext.args   = params.spades_options ? params.spades_options + ' --meta' : '--meta'
        ext.prefix = { "SPAdes-${meta.id}" }
        publishDir = [
            path: { "${params.outdir}/Assembly/SPAdes" },
            mode: params.publish_dir_mode,
            pattern: "*.{fasta.gz,gfa.gz,fa.gz,log}"
        ]
    }

    // withName: 'MULTIQC_RMHOST' {
    //     publishDir = [
    //         [
    //             path: { "${params.qc_rmhost_dir}/MultiQC" },
    //             mode: 'copy',
    //             pattern: "*multiqc_report.html",
    //             saveAs: { "rmhost_shortreads_multiqc_report.html" }
    //         ]
    //     ]
    // }

    // RGI modules configuration
    // withName: 'RGI_PREPARECARDDB' {
    //     publishDir = [
    //         [
    //             path: { "${params.rgi_preparecarddb_dir ?: "${params.outdir}/RGI/database"}" },
    //             mode: params.publish_dir_mode ?: 'copy',
    //             saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
    //         ]
    //     ]
    // }

    // withName: 'RGI_BWT' {
    //     ext.prefix = params.rgi_bwt_prefix ?: { "${meta.id}" }
    //     publishDir = [
    //         [
    //             path: { "${params.rgi_dir ?: "${params.outdir}/RGI"}/bwt/${meta.id}" },
    //             mode: params.publish_dir_mode ?: 'copy',
    //             pattern: "*/",
    //             saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
    //         },
    //         [
    //             path: { "${params.rgi_dir ?: "${params.outdir}/RGI"}/bwt/${meta.id}/json" },
    //             mode: params.publish_dir_mode ?: 'copy',
    //             pattern: "*.json"
    //         },
    //         [
    //             path: { "${params.rgi_dir ?: "${params.outdir}/RGI"}/bwt/${meta.id}/tsv" },
    //             mode: params.publish_dir_mode ?: 'copy',
    //             pattern: "*.txt"
    //         }
    //     ]
    // }

    withName: 'RGI_PREPARECARDDB' {
        publishDir = [
            path: { "${params.rgi_dir}/Databases" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename }
        ]
    }
    withName: 'RGI_BWT' {
        publishDir = [
            path: { "${params.rgi_dir}/bwt" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename }
        ]
    }

    withName: 'YACHT_RUN' {
        publishDir = [
            [
                path: { "${params.yacht_results_dir}" },
                mode: params.publish_dir_mode,
                pattern: "yacht_results/*.xlsx"
            ],
            [
                path: { "${params.yacht_results_dir}/yacht_results/version" },
                mode: params.publish_dir_mode,
                pattern: "versions.yml"
            ]
        ]
    }

    withName: 'SOURMASH_FASTMULTIGATHER' {
        publishDir = [
            [
                path: { "${params.fastmultigather_dir}" },
                mode: params.publish_dir_mode,
                pattern: "fastmultigather/*_sourmash_gather.csv"
            ],
            [
                path: { "${params.fastmultigather_dir}/fastmultigather" },
                mode: params.publish_dir_mode,
                pattern: "versions.yml"
            ]
        ]
    }

    withName: 'PROCESS_READBASED_RESULTS' {
        publishDir = [
            [
                path: { "${params.processed_results_dir}/final_results" },
                mode: params.publish_dir_mode,
                pattern: "final_results"
            ],
            [
                path: { "${params.processed_results_dir}/final_results/version" },
                mode: params.publish_dir_mode,
                pattern: "versions.yml"
            ],
            [
                path: { "${params.yacht_results_dir}/yacht_results" },
                mode: params.publish_dir_mode,
                pattern: "temp_yacht_results"
            ]
        ]
    }

    withName: 'METAQUAST' {
        publishDir = [
            path: { "${params.outdir}/Assembly/${meta.assembler}/QC/${meta.id}" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    // CONTIG_ANALYSIS modules
    withName: BWAMEM2_INDEX_CONTIGS {
        ext.prefix = { "${meta.assembler}-${meta.id}.bwamem2_idx" }
        publishDir = [
            path: { "${params.outdir}/ContigsAnalysis/bwamem2_index/" },
            pattern: "bwamem2/*",
            mode: params.publish_dir_mode,
            enabled: false  // Don't publish index files by default
        ]
    }

    withName: BWAMEM2_MEM_CONTIGS {
        ext.prefix = { "${meta.assembler}-${meta.id}" }
        publishDir = [
            path: { "${params.outdir}/ContigsAnalysis/mapped_reads/" },
            pattern: "*.{bam,yml}",
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename }
        ]
    }

    withName: 'GENOMAD_ENDTOEND' {
        ext.prefix = { "${meta.assembler}-${meta.id}.geNomad" }
        ext.args = [
            "--cleanup",
            "--min-score ${params.genomad_min_score}",
            "--splits ${params.genomad_splits}",
            "${params.genomad_e2e_options}"
        ].join(' ').trim()
        publishDir = [
            [
                path: { "${params.outdir}/ContigsAnalysis/genomad/" },
                pattern: "*/*",
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename }
            ],
            [
                path: { "${params.outdir}/ContigsAnalysis/genomad/" },
                pattern: "versions.yml",
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename }
            ]
        ]
    }

    withName: 'GENOMAD_DOWNLOAD' {
        publishDir = [
            path: { "${params.outdir}/Databases/genomad/" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> params.save_genomad_db ? filename : null }
        ]
    }

    withName: 'SKANI_SEARCH' {
        ext.prefix = { "${meta.assembler}-${meta.id}.skani" }
        ext.args = params.skani_search_options ? "${params.skani_search_options} --qi" : '--qi'
        publishDir = [
            path: { "${params.outdir}/ContigsAnalysis/skani/" },
            pattern: "*.{tsv,yml}",
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename}
        ]
    }

    withName: 'SEQKIT_FX2TAB' {
        ext.prefix = { "${meta.assembler}-${meta.id}.seqkit" }
        ext.args = "-ngli -H -C N"
        ext.suffix = "txt"  // Don't compress by default
        publishDir = [
            path: { "${params.outdir}/ContigsAnalysis/contig_stats/" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename}
        ]
    }

    withName: 'SAMTOOLS_COVERAGE' {
        ext.prefix = { "${meta.assembler}-${meta.id}.coverage" }
        publishDir = [
            path: { "${params.outdir}/ContigsAnalysis/coverage/" }, 
            pattern: "*.{txt,yml}", 
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename}
        ]
    }

    withName: TIARA_TIARA {
        ext.prefix = { "${meta.assembler}-${meta.id}.tiara" }
        ext.args = "--min_len ${params.tiara_min_length} --probabilities"
        publishDir = [
            path: { "${params.outdir}/ContigsAnalysis/Tiara/" },
            mode: params.publish_dir_mode,
            pattern: "*.{txt,yml}*",
            saveAs: { filename -> filename}
        ]
    }

    // CONTIG_ANNOTATION modules
    withName: 'PYRODIGAL' {
        ext.prefix = { "${meta.assembler}-${meta.id}.pyrodigal" }
        ext.args   = [
            params.annotation_pyrodigal_singlemode ? "-p single" : "-p meta",
            params.annotation_pyrodigal_closed ? "-c" : "",
            params.annotation_pyrodigal_forcenonsd ? "-n" : "",
            params.annotation_pyrodigal_usespecialstopcharacter ? '' : '--no-stop-codon',
            "-g ${params.annotation_pyrodigal_transtable}"
        ].join(' ').trim()
        publishDir = [
            path: { "${params.outdir}/ContigsAnalysis/annotation/pyrodigal/" },
            mode: params.publish_dir_mode,
            enabled: params.save_contig_annotations,
            pattern: "*.{faa,fna,gbk,score}.gz",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: 'PROKKA' {
        ext.prefix = { "${meta.assembler}-${meta.id}.prokka" }
        ext.args   = [
            "--kingdom ${params.annotation_prokka_kingdom}",
            "--gcode ${params.annotation_prokka_gcode}",
            "--mincontiglen ${params.annotation_prokka_mincontiglen}",
            "--evalue ${params.annotation_prokka_evalue}",
            "--coverage ${params.annotation_prokka_coverage}",
            params.annotation_prokka_retaincontigheaders ? "--force" : "--locustag PROKKA --centre CENTER",
            params.annotation_prokka_singlemode ? '' : '--metagenome',
            params.annotation_prokka_cdsrnaolap ? '--cdsrnaolap' : '',
            params.annotation_prokka_rawproduct ? '--rawproduct' : '',
            params.annotation_prokka_rnammer ? '--rnammer' : '',
            params.annotation_prokka_compliant ? '--compliant' : '',
            params.annotation_prokka_addgenes ? '--addgenes' : ''
        ].join(' ').trim()
        publishDir = [
            path: { "${params.outdir}/ContigsAnalysis/annotation/prokka/" },
            mode: params.publish_dir_mode,
            enabled: params.save_contig_annotations,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: GUNZIP {
        publishDir = [
            enabled: false
        ]
    }

    withName: BOWTIE2_ASSEMBLY_BUILD {
        ext.prefix = { "${meta.assembler}-${meta.id}" }
        publishDir = [
            path: { "${params.outdir}/Binning/mapping/bowtie2/index/${meta.assembler}" },
            mode: params.publish_dir_mode,
            pattern: "bowtie2/*",
            enabled: false  // Don't publish index by default
        ]
    }
    
    withName: BOWTIE2_ASSEMBLY_ALIGN {
        ext.prefix = { "${meta.assembler}-${meta.id}.${meta.reads_id}" }  // Include reads_id in prefix
        ext.args   = params.bowtie2_mode ?: ''
        ext.args2  = '--output-fmt bam'
        publishDir = [
            [
                path: { "${params.outdir}/Binning/mapping/bowtie2/log/${meta.assembler}/${meta.id}" },
                mode: params.publish_dir_mode,
                pattern: "*.log"
            ]
        ]
    }
    
    withName: BWAMEM2_ASSEMBLY_INDEX {
        ext.prefix = { "${meta.assembler}-${meta.id}" }
        publishDir = [
            path: { "${params.outdir}/Binning/mapping/bwamem2/index/${meta.assembler}" },
            mode: params.publish_dir_mode,
            pattern: "bwamem2/*",
            enabled: false  // Don't publish index by default
        ]
    }
    
    withName: BWAMEM2_ASSEMBLY_MEM {
        ext.prefix = { "${meta.assembler}-${meta.id}.assembly" }
        ext.args   = { "-R '@RG\\tID:${meta.id}\\tSM:${meta.id}\\tPL:ILLUMINA'" }
        ext.args2  = '--output-fmt bam'
        publishDir = [
            path: { "${params.outdir}/Binning/mapping/bwamem2/bam/${meta.assembler}/${meta.id}" },
            mode: params.publish_dir_mode,
            pattern: "*.bam",
            enabled: false  // Raw BAM not needed, sorted version will be published
        ]
    }
    
    withName: 'SAMTOOLS_SORT' {
        ext.prefix = { "${meta.assembler}-${meta.id}.sorted" }
        publishDir = [
            path: { "${params.outdir}/Binning/mapping/sorted_bam/${meta.assembler}/${meta.id}" },
            mode: params.publish_dir_mode,
            pattern: "*.bam",
            enabled: params.save_assembly_mapped_reads
        ]
    }
    
    withName: 'SAMTOOLS_INDEX' {
        publishDir = [
            path: { "${params.outdir}/Binning/mapping/sorted_bam/${meta.assembler}/${meta.id}" },
            mode: params.publish_dir_mode,
            pattern: "*.bai",
            enabled: params.save_assembly_mapped_reads
        ]
    }

    withName: METABAT2_JGISUMMARIZEBAMCONTIGDEPTHS {
        ext.prefix = { "${meta.assembler}-${meta.id}-depth" }
        publishDir = [
            path: { "${params.outdir}/Binning/depths/contigs" },
            mode: params.publish_dir_mode,
            pattern: '*-depth.txt.gz'
        ]
    }

    withName: METABAT2_METABAT2 {
        ext.prefix = { "${meta.assembler}-MetaBAT2-${meta.id}" }
        ext.args   = [
            params.min_contig_size < 1500 ? "-m 1500" : "-m ${params.min_contig_size}",
            "--unbinned",
            "--seed ${params.metabat_rng_seed}"
        ].join(' ').trim()
        publishDir = [
            [
                path: { "${params.outdir}/Binning/MetaBAT2/bins/" },
                mode: params.publish_dir_mode,
                pattern: '*[!lowDepth|tooShort|unbinned].fa.gz'
            ],
            [
                path: { "${params.outdir}/Binning/MetaBAT2/discarded" },
                mode: params.publish_dir_mode,
                pattern: '*tooShort.fa.gz'
            ],
            [
                path: { "${params.outdir}/Binning/MetaBAT2/discarded" },
                mode: params.publish_dir_mode,
                pattern: '*lowDepth.fa.gz'
            ]
        ]
    }

    withName: MAXBIN2 {
        ext.prefix = { "${meta.assembler}-MaxBin2-${meta.id}" }
        publishDir = [
            [
                path: { "${params.outdir}/Binning/MaxBin2/discarded" },
                mode: params.publish_dir_mode,
                pattern: '*.tooshort.gz'
            ],
            [
                path: { "${params.outdir}/Binning/MaxBin2/" },
                mode: params.publish_dir_mode,
                pattern: '*.{summary,abundance}'
            ]
        ]
    }

    withName: ADJUST_MAXBIN2_EXT {
        publishDir = [
            path: { "${params.outdir}/Binning/MaxBin2/bins/" },
            mode: params.publish_dir_mode,
            pattern: '*.fa.gz'
        ]
    }

    withName: 'CONCOCT_.*' {
        ext.prefix = { "${meta.assembler}-CONCOCT-${meta.id}" }
        publishDir = [
            [
                path: { "${params.outdir}/Binning/CONCOCT/stats/" },
                mode: params.publish_dir_mode,
                pattern: "*.{txt,csv,tsv}"
            ],
            [
                path: { "${params.outdir}/Binning/CONCOCT/bins" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> new File(filename).getName() },
                pattern: "*/*.fa.gz"
            ]
        ]
    }

    withName: SPLIT_FASTA {
        publishDir = [
            [
                path: { "${params.outdir}/Binning/${meta.binner}/unbinned" },
                mode: params.publish_dir_mode,
                pattern: '*.*[0-9].fa.gz'
            ],
            [
                path: { "${params.outdir}/Binning/${meta.binner}/unbinned/discarded" },
                mode: params.publish_dir_mode,
                pattern: '*.pooled.fa.gz'
            ],
            [
                path: { "${params.outdir}/Binning/${meta.binner}/unbinned/discarded" },
                mode: params.publish_dir_mode,
                pattern: '*.remaining.fa.gz'
            ]
        ]
    }

    withName: CONVERT_DEPTHS {
        publishDir = [
            enabled: false
        ]
    }

    withName: 'CONCOCT_CUTUPFASTA' {
        ext.args = '-c 10000 -o 0 --merge_last'  // Standard CONCOCT parameters for cutting contigs
        ext.prefix = { "${meta.assembler}-CONCOCT-${meta.id}" }
    }

    withName: 'CONCOCT_CONCOCTCOVERAGETABLE' {
        ext.prefix = { "${meta.assembler}-CONCOCT-${meta.id}" }
    }

    withName: 'CONCOCT_CONCOCT' {
        //ext.args = '--composition_file ${prefix}.fasta --coverage_file ${prefix}.tsv --length_threshold 1000'
        ext.prefix = { "${meta.assembler}-CONCOCT-${meta.id}" }
    }

    withName: FASTATOCONTIG2BIN_METABAT2 {
        ext.prefix = { "${meta.assembler}-MetaBAT2-${meta.id}" }
        publishDir = [
            enabled: false  // Intermediate file
        ]
    }

    withName: FASTATOCONTIG2BIN_MAXBIN2 {
        ext.prefix = { "${meta.assembler}-MaxBin2-${meta.id}" }
        publishDir = [
            enabled: false  // Intermediate file
        ]
    }

    withName: FASTATOCONTIG2BIN_CONCOCT {
        ext.prefix = { "${meta.assembler}-CONCOCT-${meta.id}" }
        publishDir = [
            enabled: false  // Intermediate file
        ]
    }

    withName: DASTOOL_DASTOOL {
        ext.prefix = { "${meta.assembler}-DASTool-${meta.id}" }
        ext.args   = "--write_bins --write_unbinned --write_bin_evals --score_threshold ${params.refine_bins_dastool_threshold}"
        publishDir = [
            [
                path: { "${params.outdir}/Binning/DASTool/stats" },
                mode: params.publish_dir_mode,
                pattern: '*.{tsv,log,eval,seqlength}'
            ]
        ]
    }

    withName: RENAME_PREBINREFINE {
        publishDir = [
            enabled: false  // Intermediate file
        ]
    }

    withName: RENAME_POSTBINREFINE {
        publishDir = [
            [
                path: { "${params.outdir}/Binning/${meta.binrefine}/bins" },
                mode: params.publish_dir_mode,
                pattern: '*-*Refined-*.fa',
            ],
            [
                path: { "${params.outdir}/Binning/${meta.binrefine}/unbinned" },
                mode: params.publish_dir_mode,
                pattern: '*-*Unbinned-*.fa',
            ],
            [
                path: { "${params.outdir}/Binning/${meta.binrefine}/stats" },
                mode: params.publish_dir_mode,
                pattern: '*.tsv'
            ],
            [
                path: { "${params.outdir}/Binning/${meta.binrefine}/logs" },
                mode: params.publish_dir_mode,
                pattern: '*.log'
            ]
        ]
    }

    withName: BINETTE_BINETTE {
        publishDir = [
            [
                path: { "${params.outdir}/Binning/Binette/stats" },
                mode: params.publish_dir_mode,
                pattern: "*_final_bins_quality_reports.tsv"
            ],
            [
                path: { "${params.outdir}/Binning/Binette/logs" },
                mode: params.publish_dir_mode,
                pattern: "*.{log,yml}"
            ],
            [
                path: { "${params.outdir}/Binning/Binette/stats" },
                mode: params.publish_dir_mode,
                pattern: "*_input_bins_quality_reports/*.tsv"
            ]
        ]
        ext.prefix = { "${meta.assembler}-Binette-${meta.id}" }
        ext.args   = "--min_completeness ${params.refine_bins_binette_min_completeness} --contamination_weight ${params.refine_bins_binette_contamination_weight}"
    }

    // ============================================================
    // Bin QC module configurations
    // ============================================================

    withName: 'QUAST_BINS|QUAST_BINS_SUMMARY' {
        publishDir = [
            path: { "${params.outdir}/Binning/QC" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename },
        ]
    }

    withName: BUSCO_UNTAR {
        ext.basedir = 'busco_db/lineages'
    }

    withName: BUSCO_BUSCO {
        ext.args = [
            params.busco_db ? '--offline' : ''
        ].join(' ').trim()
        publishDir = [
            [
                path: { "${params.outdir}/Binning/QC/BUSCO/${meta.id}" },
                mode: params.publish_dir_mode,
                pattern: "*{.txt,.json,.log,-busco}",
            ],
            [
                path: { "${params.outdir}/Databases/BUSCO" },
                mode: params.publish_dir_mode,
                overwrite: false,
                pattern: "busco_downloads/lineages/*",
                enabled: params.save_busco_db,
            ],
        ]
    }

    withName: CHECKM_UNTAR {
        publishDir = [
            path: { "${params.outdir}/Databases/CheckM" },
            mode: params.publish_dir_mode,
            overwrite: false,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename },
            enabled: params.save_checkm_data,
        ]
    }

    withName: CHECKM_LINEAGEWF {
        tag = { "${meta.assembler}-${meta.binner}-${meta.binrefine}-${meta.id}" }
        ext.prefix = { "${meta.assembler}-${meta.binner}-${meta.binrefine}-${meta.id}_lineagewf" }
        ext.args = '--reduced_tree'
        publishDir = [
            path: { "${params.outdir}/Binning/QC/CheckM" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename },
        ]
    }

    withName: CHECKM_QA {
        tag = { "${meta.assembler}-${meta.binner}-${meta.binrefine}-${meta.id}" }
        ext.prefix = { "${meta.assembler}-${meta.binner}-${meta.binrefine}-${meta.id}_qa" }
        ext.args = "-o 2 --tab_table"
        publishDir = [
            path: { "${params.outdir}/Binning/QC/CheckM" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename },
        ]
    }

    withName: CONCAT_BINQC_TSV {
        ext.prefix = { "${params.binqc_tool}_summary" }
        publishDir = [
            path: { "${params.outdir}/Binning/QC" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename },
        ]
    }

    withName: CHECKM2_DATABASEDOWNLOAD {
        publishDir = [
            path: { "${params.outdir}/Databases/CheckM2" },
            mode: params.publish_dir_mode,
            overwrite: false,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename },
            enabled: params.save_checkm2_data,
        ]
    }

    withName: CHECKM2_PREDICT {
        //tag = { "${meta.assembler}-${meta.binner}-${meta.id}" }
        ext.prefix = { "${meta.assembler}-${meta.binner}-${meta.binrefine}-${meta.id}" }
        ext.args = '--force'
        publishDir = [
            path: { "${params.outdir}/Binning/QC/CheckM2" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename },
        ]
    }

    withName: GUNC_DOWNLOADDB {
        publishDir = [
            path: { "${params.outdir}/Databases/GUNC" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename },
            enabled: params.gunc_save_db,
        ]
    }

    withName: GUNC_RUN {
        ext.args = '--detailed_output'
        publishDir = [
            path: { "${params.outdir}/Binning/QC/GUNC/raw/${meta.assembler}-${meta.binner}-${meta.binrefine}-${meta.id}/${fasta.baseName}/" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename },
        ]
    }

    withName: GUNC_MERGECHECKM {
        tag = { "${meta.assembler}-${meta.binner}-${meta.id}" }
        publishDir = [
            path: { "${params.outdir}/Binning/QC/GUNC/checkmmerged/${meta.assembler}-${meta.binner}-${meta.binrefine}-${meta.id}/${checkm_file.baseName}" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename },
        ]
    }
}
