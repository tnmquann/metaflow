params {
    config_profile_name = 'Test profile'
    config_profile_description = 'Configuration for testing purposes'

    // Input parameters
    input = "/tmp/sample_temp.csv"
    input_format = 'csv'
    outdir = 'results/tests'

    // Hostile parameters
    hostile_reference = "${projectDir}/test_data/hostile"
    hostile_index = "genome.hg38.chr21_10000bp_region"
    hostile_ref_name = "genome.hg38.chr21_10000bp_region"
    
    // Database parameters
    sourmash_database = "${projectDir}/test_data/mockupdb_r226_k31.rocksdb"
    yacht_database = "/tmp/config_temp.json"
    ksize = 31

    // RGI parameters
    rgi_aligner = 'kma'                    // kma, bowtie2, bwa
    rgi_include_wildcard = false           // Include wildcard variants
    rgi_include_other_models = false       // Include other model types
    rgi_bwt_args = null                    // Additional RGI bwt arguments
    rgi_preparecarddb_args = null          // Additional RGI preparecarddb arguments
    rgi_bwt_prefix = null                  // Custom prefix for RGI bwt outputs

    // Directory structure parameters (required to avoid null file errors)
    merged_seq_dir = "${params.outdir}/Merged sequences"
    sketches_dir = "${params.outdir}/Sourmash - YACHT/sketches"
    yacht_results_dir = "${params.outdir}/Sourmash - YACHT"
    fastmultigather_dir = "${params.outdir}/Sourmash - YACHT"
    processed_results_dir = "${params.outdir}/Sourmash - YACHT"
    qc_raw_dir = "${params.outdir}/QC/Raw_reads"
    qc_trim_dir = "${params.outdir}/QC/Trimming"
    qc_rmhost_dir = "${params.outdir}/QC/Remove host genome"
    trim_dir = "${params.outdir}/Trimming"
    rmhost_dir = "${params.outdir}/Remove host genome"
    rgi_dir = "${params.outdir}/RGI"                    // RGI output directory
    rgi_preparecarddb_dir = "${params.outdir}/RGI/database"  // RGI database directory

    // Process configurations
    hostile_clean_args = '--debug'
    publish_dir_mode = 'copy'
}

profiles {
    test {
        process {
            publishDir = [
                mode: 'copy',
                saveAs: { filename -> filename }
            ]

            // Resource settings for testing
            cpus = 2
            memory = '6.GB'
            time = '2.h'
        }

        conda {
            enabled = true
            useMamba = false
            createTimeout = '1h'
            cacheDir = "${projectDir}/work/conda"
        }

        // Disable other container technologies
        docker.enabled = false
        singularity.enabled = false
        podman.enabled = false
        shifter.enabled = false
        charliecloud.enabled = false
        apptainer.enabled = false
    }

    // RGI test profiles
    test_rgi_kma {
        params {
            rgi_aligner = 'kma'
            rgi_include_wildcard = false
        }
    }

    test_rgi_wildcard {
        params {
            rgi_aligner = 'kma'
            rgi_include_wildcard = true
        }
    }

    test_rgi_bowtie2 {
        params {
            rgi_aligner = 'bowtie2'
            rgi_include_wildcard = true
        }
    }

    test_rgi_all_models {
        params {
            rgi_aligner = 'kma'
            rgi_include_wildcard = true
            rgi_include_other_models = true
        }
    }
}

// Process configurations
process {
    cpus = { check_max( 1 * task.attempt, 'cpus' ) }
    memory = { check_max( 6.GB * task.attempt, 'memory' ) }
    time = { check_max( 4.h * task.attempt, 'time' ) }
    
    errorStrategy = { task.exitStatus in ((130..145) + [104, 134, 137, 139, 140, 143]) ? 'retry' : 'finish' }
    maxRetries = 1
    maxErrors = '-1'

    withName: 'PROCESS_READBASED_RESULTS' {
        ext.py_args_script4 = '--remove_unclassified --min_coverage 0.01'
    }

    // RGI process configurations
    withName: 'RGI_PREPARECARDDB' {
        ext.args = params.rgi_preparecarddb_args ?: ''
        publishDir = [
            path: { "${params.rgi_preparecarddb_dir}" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
        // Increase resources for database preparation
        cpus = { check_max( 2 * task.attempt, 'cpus' ) }
        memory = { check_max( 8.GB * task.attempt, 'memory' ) }
        time = { check_max( 6.h * task.attempt, 'time' ) }
    }

    withName: 'RGI_BWT' {
        ext.args = { 
            def base_args = '--local -a ' + params.rgi_aligner
            if (params.rgi_include_wildcard) base_args += ' --include_wildcard'
            if (params.rgi_include_other_models) base_args += ' --include_other_models'
            if (params.rgi_bwt_args) base_args += ' ' + params.rgi_bwt_args
            return base_args
        }
        ext.prefix = params.rgi_bwt_prefix ?: { "${meta.id}" }
        publishDir = [
            [
                path: { "${params.rgi_dir}/bwt" },
                mode: params.publish_dir_mode,
                pattern: "*/",
                saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
            ],
            [
                path: { "${params.rgi_dir}/bwt/json" },
                mode: params.publish_dir_mode,
                pattern: "*.json"
            ],
            [
                path: { "${params.rgi_dir}/bwt/tsv" },
                mode: params.publish_dir_mode,
                pattern: "*.txt"
            ]
        ]
        // Increase resources for alignment
        cpus = { check_max( 4 * task.attempt, 'cpus' ) }
        memory = { check_max( 12.GB * task.attempt, 'memory' ) }
        time = { check_max( 8.h * task.attempt, 'time' ) }
    }
}

// Executor settings
executor {
    name = 'local'
    queueSize = 4
}