params {
    config_profile_name = 'Test profile'
    config_profile_description = 'Configuration for testing purposes'

    // Input parameters
    input = "/tmp/sample_temp.csv"
    input_format = 'csv'
    outdir = 'results/tests'

    // Hostile parameters
    hostile_reference = "${projectDir}/test_data/hostile"
    hostile_index = "genome.hg38.chr21_10000bp_region"
    hostile_ref_name = "genome.hg38.chr21_10000bp_region"
    
    // Database parameters
    sourmash_database = "${projectDir}/test_data/mockupdb_r226_k31.rocksdb"
    yacht_database = "/tmp/config_temp.json"
    ksize = 31

    // Directory structure parameters (required to avoid null file errors)
    merged_seq_dir = "${params.outdir}/Merged sequences"
    sketches_dir = "${params.outdir}/Sourmash - YACHT/sketches"
    yacht_results_dir = "${params.outdir}/Sourmash - YACHT"
    fastmultigather_dir = "${params.outdir}/Sourmash - YACHT"
    processed_results_dir = "${params.outdir}/Sourmash - YACHT"
    qc_raw_dir = "${params.outdir}/QC/Raw_reads"
    qc_trim_dir = "${params.outdir}/QC/Trimming"
    qc_rmhost_dir = "${params.outdir}/QC/Remove host genome"
    trim_dir = "${params.outdir}/Trimming"
    rmhost_dir = "${params.outdir}/Remove host genome"

    // Process configurations
    hostile_clean_args = '--debug'
    publish_dir_mode = 'copy'
}

profiles {
    test {
        process {
            publishDir = [
                mode: 'copy',
                saveAs: { filename -> filename }
            ]

            // Resource settings for testing
            cpus = 2
            memory = '6.GB'
            time = '2.h'
        }

        conda {
            enabled = true
            useMamba = true
            createTimeout = '1h'
            cacheDir = "${projectDir}/work/conda"
        }

        // Disable other container technologies
        docker.enabled = false
        singularity.enabled = false
        podman.enabled = false
        shifter.enabled = false
        charliecloud.enabled = false
        apptainer.enabled = false
    }
}

// Process configurations
process {
    cpus = { check_max( 1 * task.attempt, 'cpus' ) }
    memory = { check_max( 6.GB * task.attempt, 'memory' ) }
    time = { check_max( 4.h * task.attempt, 'time' ) }
    
    errorStrategy = { task.exitStatus in ((130..145) + [104, 134, 137, 139, 140, 143]) ? 'retry' : 'finish' }
    maxRetries = 1
    maxErrors = '-1'

    withName: 'PROCESS_READBASED_RESULTS' {
        ext.py_args_script4 = '--remove_unclassified --min_coverage 0.01'
    }
}

// Executor settings
executor {
    name = 'local'
    queueSize = 4
}