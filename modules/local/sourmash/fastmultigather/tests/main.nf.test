nextflow_process {
    name "Test Process SOURMASH_FASTMULTIGATHER"
    script "./main.nf"
    process "SOURMASH_FASTMULTIGATHER"

    test("Should run sourmash fastmultigather with test data") {
        when {
            params {
                ksize = 31
                publish_dir_mode = "copy"
                fastmultigather_dir = "output"
            }
            process {
                """
                input[0] = tuple(
                    [ id: 'test_sample' ],
                    file("${projectDir}/test_data/test_sketches.zip")
                )
                input[1] = file("${projectDir}/test_data/mockupdb_r226_k31.zip")
                """
            }
        }

        then {
            assert process.success
            assert process.trace.tasks().size() == 1

            with(process.out.gather_csv) {
                assert size() == 1
                assert get(0) instanceof Map
                assert get(0)[0].id == "test_sample"
                assert path(get(0)[1]).exists()
                assert path(get(0)[1]).toString().contains("_sourmash_gather.csv")
            }

            with(process.out.versions) {
                assert path(get(0)).exists()
                assert path(get(0)).readLines().contains("\"${process.name}\":")
                assert path(get(0)).readLines().any { it.contains("sourmash:") }
                assert path(get(0)).readLines().any { it.contains("sed:") }
            }
        }
    }

    test("Should run with stub") {
        when {
            params {
                ksize = 31
                publish_dir_mode = "copy"
                fastmultigather_dir = "output"
            }
            process {
                """
                input[0] = tuple(
                    [ id: 'test_stub' ],
                    file("${projectDir}/test_data/test_sketches.zip")
                )
                input[1] = file("${projectDir}/test_data/mockupdb_r226_k31.zip")
                """
            }
        }

        then {
            options.stub = true
            assert process.success
            assert process.trace.tasks().size() == 1

            with(process.out.gather_csv) {
                assert size() == 1
                assert get(0) instanceof Map
                assert get(0)[0].id == "test_stub"
                assert path(get(0)[1]).exists()
            }

            with(process.out.versions) {
                assert path(get(0)).exists()
                assert path(get(0)).readLines().contains("\"${process.name}\":")
                assert path(get(0)).readLines().any { it.contains("stub_version") }
            }
        }
    }
}