nextflow_process {
    name "Test SOURMASH_MANYSKETCH process"
    script "./main.nf"
    process "SOURMASH_MANYSKETCH"

    test("Should run sourmash manysketch with default parameters") {
        when {
            params {
                sketches_dir = "test_sketches"
                publish_dir_mode = "copy"
                enable_copysketch = true
                ksize = 31
            }
            process {
                """
                input[0] = file("${projectDir}/test_data/test_batch.csv")
                """
            }
        }

        then {
            assert process.success
            assert process.trace.tasks().size() == 1
            
            with(process.out.manysketch_dir) {
                assert path(get(0)).exists()
            }
            
            with(process.out.zip_files_dir) {
                assert path(get(0)).exists()
            }
            
            with(process.out.sketch_zip_file) {
                assert path(get(0)).exists()
                assert path(get(0)).name == "batch.manysketch.zip"
            }
            
            with(process.out.versions) {
                assert path(get(0)).exists()
                assert path(get(0)).text.contains("sourmash")
                assert path(get(0)).text.contains("python")
                assert path(get(0)).text.contains("unzip")
            }
        }
    }

    test("Should run with stub") {
        when {
            params {
                sketches_dir = "test_sketches"
                publish_dir_mode = "copy"
                enable_copysketch = true
                ksize = 31
            }
            process {
                """
                input[0] = file("${projectDir}/test_data/test_batch.csv")
                """
            }
        }

        then {
            assert process.success
            assert process.trace.tasks().size() == 1
            
            with(process.out.manysketch_dir) {
                assert path(get(0)).exists()
            }
            
            with(process.out.zip_files_dir) {
                assert path(get(0)).exists()
            }
            
            with(process.out.sketch_zip_file) {
                assert path(get(0)).exists()
                assert path(get(0)).name == "batch.manysketch.zip"
            }
            
            with(process.out.versions) {
                assert path(get(0)).exists()
                assert path(get(0)).text.contains("stub_version")
            }
        }
    }
}