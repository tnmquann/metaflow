nextflow_process {
    name "Test YACHT_RUN process"
    script "./main.nf"
    process "YACHT_RUN"

    test("Should run YACHT with test data") {
        when {
            params {
                ksize = 31
                yacht_results_dir = "yacht_results"
                publish_dir_mode = "copy"
                enable_copyintermediate = true
            }
            
            process {
                """
                input[0] = tuple(
                    [id: 'test_sample'],
                    file("${projectDir}/test_data/signatures/")
                )
                input[1] = file("${projectDir}/test_data/mockupdb_r226_k31_thresh_0.995/mockupdb_r226_k31_thresh_0.995_config.json")
                """
            }
        }

        then {
            assert process.success
            assert process.trace.tasks().size() == 1
            
            with(process.out.yacht_xlsx) {
                assert size() == 1
                assert get(0)[0].id == 'test_sample'
                assert path(get(0)[1]).toString().endsWith('.xlsx')
            }
            
            with(process.out.versions) {
                assert path(get(0)).readLines().any { it.contains("yacht:") }
            }
        }
    }

    test("Should run with stub") {
        when {
            params {
                ksize = 31
                yacht_results_dir = "yacht_results"
                publish_dir_mode = "copy"
                enable_copyintermediate = true
            }
            
            process {
                """
                input[0] = tuple(
                    [id: 'test_stub'],
                    file("${projectDir}/test_data/signatures/")
                )
                input[1] = file("${projectDir}/test_data/mockupdb_r226_k31_thresh_0.995/mockupdb_r226_k31_thresh_0.995_config.json")
                """
            }
        }

        then {
            options.stub = true
            assert process.success
            
            with(process.out.yacht_xlsx) {
                assert size() == 1
                assert get(0)[0].id == 'test_stub'
                assert path(get(0)[1]).toString().contains('test_stub_yacht.xlsx')
            }
            
            with(process.out.versions) {
                assert path(get(0)).readLines().contains('        yacht: "stub_version"')
            }
        }
    }
}