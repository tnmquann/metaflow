nextflow_process {

    name "Test Process RGI_BWT"
    script "../main.nf"
    process "RGI_BWT"

    tag "modules"
    tag "modules_nfcore"
    tag "rgi"
    tag "rgi/bwt"
    tag "rgi/preparecarddb"

    setup {
        run("RGI_PREPARECARDDB") {
            script "../../preparecarddb/main.nf"
            process {
                """
                input[0] = []  // Empty input - triggers download mode
                """
            }
        }
    }

    test("rgi/bwt - minigut sample - paired end fastq") {

        when {
            process {
                """
                input[0] = [
                    [ id:'test_minigut', single_end:false ],
                    file('https://github.com/nf-core/test-datasets/raw/mag/test_data/test_minigut_sample2_R1.fastq.gz', checkIfExists: true),
                    file('https://github.com/nf-core/test-datasets/raw/mag/test_data/test_minigut_sample2_R2.fastq.gz', checkIfExists: true)
                ]
                input[1] = RGI_PREPARECARDDB.out.db
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(
                    process.out.versions,
                    process.out.json,
                    process.out.tsv,
                    file(process.out.outdir.get(0).get(1)).list().sort()
                    ).match() }
            )
        }
    }

    test("rgi/bwt - minigut sample - paired end fastq - stub") {

        options "-stub"

        when {
            process {
                """
                input[0] = [
                    [ id:'test_minigut', single_end:false ],
                    file('https://github.com/nf-core/test-datasets/raw/mag/test_data/test_minigut_sample2_R1.fastq.gz', checkIfExists: true),
                    file('https://github.com/nf-core/test-datasets/raw/mag/test_data/test_minigut_sample2_R2.fastq.gz', checkIfExists: true)
                ]
                input[1] = RGI_PREPARECARDDB.out.db
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out).match() }
            )
        }
    }

    test("rgi/bwt - minigut sample - with bowtie2 aligner") {

        config "./nextflow.config"

        when {
            params {
                rgi_bwt_args = '-a bowtie2'
            }
            process {
                """
                input[0] = [
                    [ id:'test_minigut_bowtie2', single_end:false ],
                    file('https://github.com/nf-core/test-datasets/raw/mag/test_data/test_minigut_sample2_R1.fastq.gz', checkIfExists: true),
                    file('https://github.com/nf-core/test-datasets/raw/mag/test_data/test_minigut_sample2_R2.fastq.gz', checkIfExists: true)
                ]
                input[1] = RGI_PREPARECARDDB.out.db
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(
                    process.out.versions,
                    process.out.json,
                    process.out.tsv
                    ).match() }
            )
        }
    }

    test("rgi/bwt - minigut sample - with wildcard inclusion") {

        config "./nextflow.config"

        when {
            params {
                rgi_bwt_args = '--include_wildcard'
            }
            process {
                """
                input[0] = [
                    [ id:'test_minigut_wildcard', single_end:false ],
                    file('https://github.com/nf-core/test-datasets/raw/mag/test_data/test_minigut_sample2_R1.fastq.gz', checkIfExists: true),
                    file('https://github.com/nf-core/test-datasets/raw/mag/test_data/test_minigut_sample2_R2.fastq.gz', checkIfExists: true)
                ]
                input[1] = RGI_PREPARECARDDB.out.db
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(
                    process.out.versions,
                    process.out.json,
                    process.out.tsv
                    ).match() }
            )
        }
    }

    test("rgi/bwt - minigut sample - with other models") {

        config "./nextflow.config"

        when {
            params {
                rgi_bwt_args = '--include_other_models'
            }
            process {
                """
                input[0] = [
                    [ id:'test_minigut_other_models', single_end:false ],
                    file('https://github.com/nf-core/test-datasets/raw/mag/test_data/test_minigut_sample2_R1.fastq.gz', checkIfExists: true),
                    file('https://github.com/nf-core/test-datasets/raw/mag/test_data/test_minigut_sample2_R2.fastq.gz', checkIfExists: true)
                ]
                input[1] = RGI_PREPARECARDDB.out.db
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(
                    process.out.versions,
                    process.out.json,
                    process.out.tsv
                    ).match() }
            )
        }
    }

    test("rgi/bwt - validate database structure") {

        when {
            process {
                """
                input[0] = [
                    [ id:'test_db_structure', single_end:false ],
                    file('https://github.com/nf-core/test-datasets/raw/mag/test_data/test_minigut_sample2_R1.fastq.gz', checkIfExists: true),
                    file('https://github.com/nf-core/test-datasets/raw/mag/test_data/test_minigut_sample2_R2.fastq.gz', checkIfExists: true)
                ]
                input[1] = RGI_PREPARECARDDB.out.db
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                // Validate database structure from RGI_PREPARECARDDB
                {
                    def db_dir = RGI_PREPARECARDDB.out.db
                    assert path("${db_dir}/localDB").exists()
                    assert path("${db_dir}/card.json").exists()
                    def fasta_files = file(db_dir).list().findAll { it.toString().endsWith('.fasta') }
                    assert fasta_files.size() > 0
                },
                // Check RGI_BWT outputs
                { assert process.out.outdir },
                { assert process.out.json },
                { assert process.out.tsv },
                { assert process.out.versions }
            )
        }
    }

    test("rgi/bwt - validate expected output files") {

        when {
            process {
                """
                input[0] = [
                    [ id:'test_files', single_end:false ],
                    file('https://github.com/nf-core/test-datasets/raw/mag/test_data/test_minigut_sample2_R1.fastq.gz', checkIfExists: true),
                    file('https://github.com/nf-core/test-datasets/raw/mag/test_data/test_minigut_sample2_R2.fastq.gz', checkIfExists: true)
                ]
                input[1] = RGI_PREPARECARDDB.out.db
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                // Check for expected RGI bwt output files
                {
                    def output_dir = process.out.outdir[0][1]
                    def files = file(output_dir).list()
                    def expected_patterns = [
                        'allele_mapping_data.txt',
                        'gene_mapping_data.txt', 
                        'artifacts_mapping_stats.txt',
                        'overall_mapping_stats.txt',
                        'reference_mapping_stats.txt'
                    ]
                    expected_patterns.each { pattern ->
                        assert files.any { it.toString().contains(pattern) }
                    }
                },
                // Validate JSON content structure
                { 
                    def json_files = process.out.json[0][1]
                    assert json_files.size() > 0
                    def json_content = path(json_files[0]).json
                    assert json_content != null
                },
                // Check versions file format
                {
                    def versions_content = path(process.out.versions[0]).text
                    assert versions_content.contains('"rgi":')
                    assert versions_content.contains('"rgi-database":')
                }
            )
        }
    }

    test("rgi/bwt - test database version consistency") {

        when {
            process {
                """
                input[0] = [
                    [ id:'test_version', single_end:false ],
                    file('https://github.com/nf-core/test-datasets/raw/mag/test_data/test_minigut_sample2_R1.fastq.gz', checkIfExists: true),
                    file('https://github.com/nf-core/test-datasets/raw/mag/test_data/test_minigut_sample2_R2.fastq.gz', checkIfExists: true)
                ]
                input[1] = RGI_PREPARECARDDB.out.db
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                // Check version consistency between setup and process
                {
                    def prep_db_version = RGI_PREPARECARDDB.out.db_version
                    def bwt_versions = path(process.out.versions[0]).text
                    // Both should report same database version
                    assert bwt_versions.contains('rgi-database')
                }
            )
        }
    }
}